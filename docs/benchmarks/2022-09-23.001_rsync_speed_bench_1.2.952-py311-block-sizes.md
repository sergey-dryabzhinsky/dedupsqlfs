# Простые тесты скорости работы DedupSQLfs v1.2.952 за 23.03.2023

Проверка работы блоков разных размеров на больших данных.
Плюс - исправленная версия модуля zstd, обновленная - lz4.
Установка размера page_size для таблицы блоков данных.

Cинхронизация Qt 5.12.12, 5.15.8, 6.4.3 с помощью rsync.

Проверка работы на движке: sqlite 3.40.1

- CPU: i5-6600K @ 3.50GHz
- DISK: 500Gb SSD NVMe

System: Ubuntu 18.04 amd64

Kernel: 5.4.0-144-lowlatency

Python: 3.11.2 +
- recordclass: 0.18.3
- llfuse: 1.4.2
- lz4: 1.9.4
- zstd: 1.5.4
- brotli: 1.0.9

Размер Qt в tar:

* 5.12.12 - 2825M, 284985 файлов, 24412 каталога
* 5.15.8 - 3734M, 339135 файлов, 31568 каталогов
* 6.4.3 - 4013M, 333876 файлов, 33674 каталога

Другое: включен autocommit, выключен sync, hash=md5

Команда:
```sh
/usr/bin/time -v python3.11 ./mount.dedupsqlfs -vv --verbose-stats --data $HOME/Temp/sqlfs/data/ \
 --compress lz4 \
 --block-size {size} \
 --no-sync --no-cache-flusher --minimal-compress-size -1 \
 --multi-cpu single \
 -o noatime $HOME/Temp/sqlfs/mount
```

Синхронизация Qt:
```sh
rsync-3.2 -aHh --stats --delete --sparse --inplace --no-whole-file {qt-dir}/ $HOME/Temp/sqlfs/mount/Qt/ && sudo umount $HOME/Temp/sqlfs/mount
```

Синхронизация происходила поверх предыдущих копий Qt. Тестировалась в том числе и дедупликация.

Тестировались только методы:

* none
* zstd(:1)
* brotli(:0)
* lz4

Тестировались размеры блоков (--block-size): 1k, 4k, 8k, 16k, 32k, 64k, 128k(default), 256k, 512k, 1024k

## Тесты

| Qt ver   |           | 5.12.12                                                ||||| 5.15.8                                                 ||||| 6.4.3                                                  |||||
|----------|:---------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|
| **Mode** | **block** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** |
|          |   1k      | 12:32.67 | 350        | 4.81       | 3.27       | 3081     | 13:50.59 | 437        | 6.24       | 2.75       | 5690     | 16:35.06 | 509        | 6.76       | 2.56       | 9006     |
| single   |   4k      | 7:39.17  | 246        | 12.58      | 5.38       | 2679     | 8:00.51  | 301        | 15.73      | 4.64       | 4967     | 9:18.94  | 334        | 14.28      | 4.50       | 7884     |
| none     |   8k      | 6:20.74  | 206        | 16.94      | 6.48       | 2529     | 6:41.21  | 273        | 20.79      | 5.52       | 4724     | 9:35.32  | 274        | 17.30      | 4.37       | 7505     |
|          |  16k      | 6:29.03  | 188        | 18.47      | 6.33       | 2460     | 6:32.48  | 264        | 24.39      | 5.61       | 4631     | 8:03.21  | 259        | 22.41      | 5.19       | 7416     |
|          |  32k      | 6:07.60  | 172        | 20.42      | 6.68       | 2430     | 7:28.42  | 214        | 26.42      | 4.87       | 4604     | 8:22.90  | 537        | 24.87      | 4.96       | 7421     |
|          |  64k      | 5:55.19  | 166        | 24.13      | 6.92       | 2418     | 5:42.75  | 247        | 31.87      | 6.34       | 4560     | 6:59.09  | 264        | 30.10      | 5.95       | 7408     |
|          | 128k      | 6:34.68  | 169        | 21.17      | 6.23       | 2415     | 6:42.96  | 267        | 30.00      | 5.39       | 4616     | 8:07.02  | 217        | 28.57      | 5.12       | 7449     |
|          | 256k      | 6:19.67  | 162        | 22.18      | 6.46       | 2417     | 6:01.55  | 249        | 32.86      | 6.00       | 4618     | 7:02.27  | 272        | 31.53      | 5.93       | 7531     |
|          | 512k      | 5:55.21  | 168        | 23.36      | 6.90       | 2418     | 6:03.09  | 261        | 33.47      | 6.07       | 4642     | 7:21.48  | 285        | 31.61      | 5.75       | 7510     |
|          | 1024k     | 5:52.87  | 175        | 23.99      | 7.00       | 2418     | 6:52.11  | 237        | 30.08      | 5.25       | 4624     | 8:30.70  | 239        | 29.24      | 4.88       | 7530     |
| **Mode** | **block** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** |
|          |   1k      | 12:50.61 | 291        | 3.09       | 3.21       | 1830     | 14:08.80 | 361        | 4.49       | 2.66       | 3276     | 17:34.82 | 419        | 3.46       | 2.40       | 5066     |
| single   |   4k      |   |         |       |        |      |   |         |      |        |      |    |         |       |        |     |
| lz4      |   8k      |   |         |       |        |      |   |         |       |        |      |   |         |       |        |      |
|          |  16k      |   |         |       |        |      |   |         |       |        |      |   |         |       |        |      |
|          |  32k      |   |         |       |        |      |   |         |       |        |      |   |         |       |        |      |
|          |  64k      | 5:40.71  | 162        | 10.75      | 7.21       | 1176     | 5:53.30  | 230        | 16.27      | 6.16       | 2120     | 7:07.01  | 265        | 13.80      | 5.84       | 3292     |
|          | 128k      | 5:37.19  | 171        | 11.26      | 7.32       | 1162     | 5:36.46  | 247        | 18.07      | 6.44       | 2097     | 8:10.38  | 246        | 12.83      | 5.07       | 3270     |
|          | 256k      |   |         |       |        |      |   |         |       |        |      |   |         |       |        |      |
|          | 512k      |   |         |       |        |      |   |         |       |        |      |   |         |       |        |      |
|          | 1024k     |   |         |       |        |      |   |         |       |        |      |   |         |       |        |      |
| **Mode** | **block** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** |
|          |   1k      | 14:07.69  | 288        | 2.29      | 2.91       | 1538     | 13:48.52 | 360        | 3.49       | 2.73       | 2710     | 17:56.35 | 386        | 2.88       | 2.35       | 4164     |
| single   |   4k      |   |         |       |        |      |   |         |       |        |      |   |         |       |        |      |
| zstd:1   |   8k      |   |         |       |        |      |   |         |       |        |      |   |         |       |        |      |
|          |  16k      |   |         |       |        |      |   |         |       |        |      |   |         |       |        |      |
|          |  32k      |   |         |       |        |      |   |         |       |        |      |   |         |       |        |      |
|          |  64k      | 6:16.28   | 169        | 7.35      | 6.53       | 963     | 6:09.95  | 234       | 11.13      | 5.88       | 1656     | 7:29.03  | 286        | 11.13      | 5.55       | 2543     |
|          | 128k      | 5:44.75   | 164        | 8.33      | 7.13       | 950     | 6:36.29  | 222       | 12.69      | 5.47       | 1635     | 7:08.61  | 293        | 10.58      | 5.82       | 2516     |
|          | 256k      |   |         |       |        |      |   |         |       |        |      |   |         |       |        |      |
|          | 512k      |   |         |       |        |      |   |         |       |        |      |   |         |       |        |      |
|          | 1024k     |   |         |       |        |      |   |         |       |        |      |   |         |       |        |      |
| **Mode** | **block** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** |
|          |   1k      | 13:41.16 | 298        | 2.52       | 2.98       | 1703     | 15:41.26  | 360       | 3.20       | 2.40       | 3017     | 18:55.74 | 389        | 3.14       | 2.22       | 4654     |
| single   |   4k      |   |         |       |        |      |   |         |       |        |      |   |         |       |        |      |
| brotli:0 |   8k      |   |         |       |        |      |   |         |       |        |      |   |         |       |        |      |
|          |  16k      |   |         |       |        |      |   |         |       |        |      |   |         |       |        |      |
|          |  32k      |   |         |       |        |       |   |         |       |        |      |   |         |       |        |      |
|          |  64k      | 5:48.07  | 162        | 8.71      | 7.06       | 1003      | 6:20.83  | 221        | 13.70      | 5.72       | 1781     | 7:33.85  | 257        | 9.79       | 5.50       | 2740     |
|          | 128k      | 6:09.87  | 165        | 8.28      | 6.66       | 994       | 6:43.20  | 218        | 12.30      | 5.39       | 1763     | 8:17.68  | 236        | 10.08      | 5.00       | 2713     |
|          | 256k      |   |         |       |        |       |   |         |       |        |       |   |         |       |        |     |
|          | 512k      |   |         |       |        |       |   |         |       |        |       |   |         |       |        |     |
|          | 1024k     |   |         |       |        |       |   |         |       |        |       |   |         |       |        |     |
| **Mode** | **block** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** |
|          |   1k      | 13:16.90 | 329        | 2.21       | 3.10       | 1538     | 14:50.28 | 378        | 3.24       | 2.54       | 2721     | 20:51.93 | 375        | 2.46       | 2.01       | 4176     |
| single   |   4k      |   |         |       |        |      |   |         |       |        |      |   |         |       |        |      |
| brotli:0 |   8k      |   |         |       |        |      |   |         |       |        |      |   |         |       |        |      |
| lz4      |  16k      |   |         |       |        |      |   |         |       |        |      |   |         |       |        |      |
| zstd:1   |  32k      |   |         |       |        |       |   |         |       |        |      |   |         |       |        |      |
|          |  64k      | 6:01.70  | 172        | 6.69       | 6.81       | 963      | 5:36.78  | 262        | 12.21      | 6.46       | 1662     | 7:12.67  | 266        | 9.03       | 5.76       | 2549     |
|          | 128k      | 5:47.55  | 179        | 7.47       | 7.08       | 950      | 5:52.73  | 244        | 11.22      | 6.16       | 1637     | 7:10.89  | 285        | 9.68       | 5.79       | 2514     |
|          | 256k      |   |         |       |        |       |   |         |       |        |       |   |         |       |        |      |
|          | 512k      |   |         |       |        |       |   |         |       |        |       |   |         |       |        |      |
|          | 1024k     |   |         |       |        |       |   |         |       |        |       |   |         |       |        |      |

* :time   - время работы dedupsqlfs, в том числе и umount
* :memory - размер в памяти, согласно отладке в time, max resident size MiB
* :speedD - показатели отладки dedupsqlfs по скорости потоковой записи данных, MiB/s
* :speedR - показатели rsync по скорости записи данных, MiB/s
* :size   - размер итоговых данных в ~/Temp/sqlfs/data/, MiB

## Результат

Просто посмотреть и сравнить скорость работы с разным размером блоков. И сколько памяти тратится.
