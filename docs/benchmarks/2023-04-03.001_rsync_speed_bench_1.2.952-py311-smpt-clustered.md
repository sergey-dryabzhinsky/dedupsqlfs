# Простые тесты скорости работы DedupSQLfs v1.2.952 за 03.04.2023

Проверка работы много-поточно-процессности на больших данных.
Плюс - исправленная версия модуля zstd, обновленная - lz4.
Плюс - кластерные таблицы блоков, хешей.
Плюс - новые версии Qt.

Cинхронизация Qt с помощью rsync.

Проверка работы на движке: sqlite 3.40.1

- CPU: i5-6600K @ 3.50GHz
- DISK: 500Gb SSD NVMe
- Файлы Qt лежат на squashfs+zstd

System: Ubuntu 18.04 amd64

Kernel: 5.4.0-144-lowlatency

Python: 3.11.2

Размер Qt в tar:

* 5.12.12 - 2825M (596M squashed)
* 5.15.8 - 3734M (741M squashed)
* 6.2.4 - 3611M (753 squashed)
* 6.4.3 - 4013M (866 squahsed)
* 6.5.0 - 4074M (862 squashed)

Другое: включен autocommit, выключен sync, hash=md5

Команда:
```sh
/usr/bin/time -v python3.11 ./mount.dedupsqlfs -vv --verbose-stats \
 --data $HOME/Temp/sqlfs/data/ \
 --data-clustered $HOME/Temp/sqlfs/cldata/ \
 --compress zstd:6 --compress lz4 --compress brotli:2 \
 --no-sync --no-cache-flusher --minimal-compress-size -1 \
 --multi-cpu {mode} \
 -o noatime $HOME/Temp/sqlfs/mount
```

Синхронизация Qt:
```sh
rsync -aHh --stats --delete --sparse --inplace --no-whole-file {qt-dir}/ $HOME/Temp/sqlfs/mount/Qt/ && sudo umount $HOME/Temp/sqlfs/mount
```

Синхронизация происходила поверх предыдущих копий Qt. Тестировалась в том числе и дедупликация.

Тестировались только методы (--compress):

* none
* zstd:6 + lz4 + brotli:2

Тестировались режимы работы (--multi-cpu):

* single
* thread
* process

## Тесты

| Qt ver      | 5.12.12                                                ||||| 5.15.8                                                 ||||| 6.2.4                                                  ||||| 6.4.3                                                  ||||| 6.5.0                                                  |||||
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|
| **Mode**    | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** |
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|
| none/single | 5:28.38  | 171        | 23.00      | 7.88       | 56+2364  | 5:04.59  | 274        | 30.57      | 7.35       | 75+4525  | 6:49.65  | 306        | 30.52      | 3.94       | 85+6316  | 8:01.29  | 294        | 29.00      | 4.26       | 94+8841  | 8:32.25  | 255        | 29.19      | 3.09       | 100+10998 |
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|
| zst+lz4+br/
   single     | 6:17.11  | 171        | 5.67       | 6.60       | 56+854   | 6:15.32  | 265        | 9.22       | 5.82       | 75+1488  | 5:45.41  | 301        | 9.73       | 4.64       | 85+1991  | 6:45.63  | 305        | 7.36       | 5.01       | 94+2700  | 6:01.21  | 301        | 8.11       | 4.37       | 99+3280 |
| thread      | 7:11.24  | 197        | 5.62       | 5.73       | 56+860   | 7:33.98  | 283        | 8.83       | 4.79       | 75+1497  | 5:22.32  | 334        | 11.29      | 4.96       | 85+2004  | 6:43.10  | 367        | 9.48       | 5.05       | 94+2724  | 5:59.21  | 358        | 11.00      | 4.38       | 100+3308 |
| process     | 5:44.94  | 175        | 6.63       | 7.16       | 56+865   | 5:57.01  | 612        | 11.17      | 6.12       | 75+1500  | 6:16.97  | 262        | 11.17      | 4.26       | 85+2003  | 6:52.47  | 300        | 10.13      | 4.93       | 94+2714  | 18:16.80 | 172        | 5.66       | 1.43       | 100+3296 |

* :time   - время работы dedupsqlfs, в том числе и umount
* :memory - размер в памяти, согласно отладке в time, max resident size MiB
* :speedD - показатели отладки dedupsqlfs по скорости записи данных, MiB/s
* :speedR - показатели rsync по скорости записи данных, MiB/s
* :size   - размер итоговых данных в ~/Temp/sqlfs/data/, MiB + размер итоговых данных в ~/Temp/sqlfs/cldata/, MiB

## Результат

Просто посмотреть и сравнить обновление версии модуля. И сколько памяти тратится.

- rsync более агрессивно испольует ФС при синхронизации
- и много-поточность сжатия - немного ускоряет работу ФС
- и много-процессность сжатия - немного ускоряет работу ФС, видимо нужно использовать при более затратных методах сжатия
- плюс python3.11 работает быстрее, чем старые версии
- сжатие позитивно сказывается на времени синхронизации, меньше данных писать на диск
