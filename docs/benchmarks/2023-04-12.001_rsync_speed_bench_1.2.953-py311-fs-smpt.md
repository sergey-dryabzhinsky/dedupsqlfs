# Простые тесты скорости работы DedupSQLfs v1.2.953-dev за 12.04.2023

Проверка работы много-поточно-процессности на больших данных.
Плюс - новая версия python3.11, модуля zstd.
Новый вариант хранения блоков данных - на ФС.

Cинхронизация Qt с помощью rsync.

Проверка работы на движке: sqlite 3.40.1

- CPU: i5-6600K @ 3.50GHz
- DISK: 500Gb SSD NVMe

System: Ubuntu 18.04 amd64

Kernel: 5.4.0-146-lowlatency

Python: 3.11.3
- llfuse 1.4.2
- recordclass 0.18.3

RSync: 3.2.7

Размер Qt в tar / squashfs:

* 5.12.12 - 2825M (596M squashed)
* 5.15.8 - 3734M (741M squashed)
* 6.2.4 - 3611M (753 squashed)
* 6.4.3 - 4013M (866 squahsed)
* 6.5.0 - 4074M (862 squashed)

Другое: включен autocommit, выключен sync, hash=md5

Команда:
```sh
/usr/bin/time -v python3.11 ./mount.dedupsqlfs \
 -vv --verbose-stats --memory-usage \
 --data $HOME/Temp/sqlfs/data/ \
 --compress {method} \
 --no-sync --no-cache-flusher --minimal-compress-size -1 \
 --multi-cpu {mode} \
 -o noatime $HOME/Temp/sqlfs/mount
```

Синхронизация Qt:
```sh
rsync -aHh --stats --delete --sparse --inplace --no-whole-file {qt-dir}/ $HOME/Temp/sqlfs/mount/Qt/ && sudo umount $HOME/Temp/sqlfs/mount
```

Синхронизация происходила поверх предыдущих копий Qt. Тестировалась в том числе и дедупликация.

Тестировались только методы:

* none
* zstd

Тестировались режимы работы (--multi-cpu):

* single
* thread
* process

## Тесты

| Qt ver     | 5.12.12                                                ||||| 5.15.8                                                 ||||| 6.4.3                                                  |||||
|------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|
| **Mode**   | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** |
| none/single| 8:50.49  | 149.47     | 8.37       | 4.65       | 2293     | 9:18.47  | 228.88     | 13.24      | 3.94       | 4391     | 11:58.88 | 209.55     | 14.53      | 3.50       | 7101     |
|------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|
| zstd/
   single    | 9:06.82  | 148.01     | 3.49       | 4.53       | 865      | 10:18.82 | 204.15     | 5.97       | 3.50       | 1470     | 12:45.15 | 192.84     | 3.74       | 3.27       | 2234     |
| thread     | 10:27.43 | 216.19     | 2.90       | 3.91       | 866      | 8:42.23  | 333.15     | 5.00       | 4.15       | 1473     | 13:17.69 | 304.07     | 3.82       | 3.13       | 2238     |
| process    | 9:50.26  | 158.14     | 2.67       | 4.15       | 866      | 9:04.96  | 240.16     | 4.56       | 3.97       | 1474     | 12:38.65 | 226.92     | 4.00       | 3.29       | 2240     |

* :time   - время работы dedupsqlfs, в том числе и umount
* :memory - размер в памяти, согласно отладке dedupsqlfs, max resident size MiB
* :speedD - показатели отладки dedupsqlfs по скорости записи данных, MiB/s
* :speedR - показатели rsync по скорости записи данных, MiB/s
* :size   - размер итоговых данных в ~/Temp/sqlfs/data/, MiB

## Результат

Просто посмотреть и сравнить обновление версии модуля. И сколько памяти тратится.

- хранение данных блоков на файловой системе никак не ускорило работу ФС, скорее замедлило
- причина - в медленной реализации `os.makedirs`
- памяти стало потребляться меньше, на диске занимает меньше места
