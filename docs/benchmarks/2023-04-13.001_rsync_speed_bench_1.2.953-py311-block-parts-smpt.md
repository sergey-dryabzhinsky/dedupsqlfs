# Простые тесты скорости работы DedupSQLfs v1.2.953-dev за 13.04.2023

Проверка работы много-поточно-процессности на больших данных.
Плюс - новая версия python3.11, модуля zstd.
Новый вариант хранения блоков данных - с партиционированием.

Cинхронизация Qt с помощью rsync.

Проверка работы на движке: sqlite 3.40.1

- CPU: i5-6600K @ 3.50GHz
- DISK: 500Gb SSD NVMe

System: Ubuntu 18.04 amd64

Kernel: 5.4.0-146-lowlatency

Python: 3.11.3
- llfuse 1.4.2
- recordclass 0.18.3

RSync: 3.2.7

Размер Qt в tar / squashfs:

* 5.12.12 - 2825M (596M squashed)
* 5.15.8 - 3734M (741M squashed)
* 6.2.4 - 3611M (753 squashed)
* 6.4.3 - 4013M (866 squahsed)
* 6.5.0 - 4074M (862 squashed)

Другое: включен autocommit, выключен sync, hash=md5

Команда:
```sh
/usr/bin/time -v python3.11 ./mount.dedupsqlfs \
 -vv --verbose-stats --memory-usage \
 --data $HOME/Temp/sqlfs/data/ \
 --compress {method} \
 --no-sync --no-cache-flusher --minimal-compress-size -1 \
 --multi-cpu {mode} \
 --block-partitions 10 \
 -o noatime $HOME/Temp/sqlfs/mount
```

Синхронизация Qt:
```sh
rsync -aHh --stats --delete --sparse --inplace --no-whole-file {qt-dir}/ $HOME/Temp/sqlfs/mount/Qt/ && sudo umount $HOME/Temp/sqlfs/mount
```

Синхронизация происходила поверх предыдущих копий Qt. Тестировалась в том числе и дедупликация.

Тестировались только методы (`--compress`):

* none
* zstd

Тестировались режимы работы (`--multi-cpu`):

* single
* thread
* process

## Тесты

| Qt ver     | 5.12.12                                                ||||| 5.15.8                                                 ||||| 6.4.3                                                  |||||
|------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|
| **Mode**   | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** |
| none/single| 5:26.50  | 206.54     | 23.34      | 7.56       | 2418     | 5:51.07  | 299.02     | 35.38      | 6.34       | 4611     | 6:56.97  | 336.34     | 32.26      | 6.13       | 7417     |
|------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|
| zstd/
   single    | 5:18.11  | 202.48     | 7.95       | 7.78       | 943      | 5:36.35  | 308.84     | 12.31      | 6.49       | 1619     | 6:35.20  | 316.41     | 10.54      | 6.33       | 2482     |
| thread     | 5:14.96  | 272.22     | 8.02       | 7.83       | 947      | 5:24.84  | 340.95     | 13.21      | 6.69       | 1622     | 7:19.83  | 345.80     | 10.00      | 5.69       | 2489     |
| process    | 5:46.78  | 210.14     | 7.34       | 7.10       | 947      | 6:13.90  | 273.78     | 11.02      | 5.81       | 1628     | 6:54.70  | 334.44     | 9.62       | 6.02       | 2496     |

* :time   - время работы dedupsqlfs, в том числе и umount
* :memory - размер в памяти, согласно отладке dedupsqlfs, max resident size MiB
* :speedD - показатели отладки dedupsqlfs по скорости записи данных, MiB/s
* :speedR - показатели rsync по скорости записи данных, MiB/s
* :size   - размер итоговых данных в ~/Temp/sqlfs/data/, MiB

## Результат

Просто посмотреть и сравнить обновление. И сколько памяти тратится.

- хранение данных блоков c партиционированием чуть ускоряет работу
- памяти стало потребляться чуть больше
- мульти-поточность немного ускоряет работу
- мульти-процессность немного замедляет работу, нужно использовать только если будут работать медленные методы сжатия
