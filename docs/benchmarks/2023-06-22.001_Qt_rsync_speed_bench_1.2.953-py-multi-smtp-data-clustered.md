# Простые тесты скорости работы DedupSQLfs v1.2.953 за 22.06.2023

Проверка работы много-поточно-процессности на больших данных.
Плюс - исправленная+обновленная версия модуля zstd, и обновленные - llfuse, recordclass.
Плюс - кластерные таблицы блоков, хешей.
Плюс - новые версии Qt, python.
Плюс - проверка работы "партиционирования" таблицы-файла блоков.

Cинхронизация Qt с помощью rsync.

Проверка работы на движке: sqlite 3.40.1

- CPU: i5-6600K @ 3.50GHz
- DISK: 500Gb SSD NVMe
- Файлы Qt лежат на squashfs+zstd

System: Ubuntu 18.04 amd64

Disk FS: ext4, no barrier

Kernel: 5.4.0-150-lowlatency

Python:
- 3.7.17
- 3.8.17
- 3.9.17
- 3.10.12
- 3.11.4
- 3.12.0~b3

Модули:
- zstd: 1.5.5-r1
- llfuse: 1.4.4
- recordclass: 0.18.4

Размер Qt в tar:

* 5.12.12 - 2296M (596M squashed)
* 5.15.10 - 3102M (742M squashed)
* 6.2.4 - 3034M (753 squashed)
* 6.4.3 - 3387M (866 squahsed)
* 6.5.1 - 3482M (867 squashed)

Другое: включен autocommit, выключен sync, hash=md5, blocksize=128k, 

Команда:
```sh
/usr/bin/time -v python3.11 ./mount.dedupsqlfs -vv --verbose-stats --memory-usage \
 --data $HOME/Temp/sqlfs/data/ \
 --data-clustered $HOME/Temp/sqlfs/cldata/ \
 --block-partitions 10 \
 --compress zstd:3 \
 --no-sync --no-cache-flusher --minimal-compress-size -1 \
 --multi-cpu {mode} \
 -o noatime $HOME/Temp/sqlfs/mount
```

Синхронизация Qt:
```sh
rsync-3.2 -aHh --stats --delete --sparse --inplace --no-whole-file {qt-dir}/ $HOME/Temp/sqlfs/mount/Qt/ && sudo umount $HOME/Temp/sqlfs/mount
```

Синхронизация происходила поверх предыдущих копий Qt.
Тестировалась в том числе и дедупликация.
После синхронизации не делалась дефрагментация и vacuum.

Тестировались только методы (--compress):

* none
* zstd:3

Тестировались режимы работы (--multi-cpu):

* single
* thread
* process

## Тесты

| Qt ver      | 5.12.12                                                ||||| 5.15.10                                                ||||| 6.2.4                                                  ||||| 6.4.3                                                  ||||| 6.5.1                                                   |||||
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| **Mode**    | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** |  **size** |
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| rsync only  | 0:19.96  | 57         | -          | 118.60     | 2296     | 0:34.79  | 48         | -          | 54,25      | 3102     | 0:37.87  | 63         | -          | 40,30      | 3034     | 0:42.90  | 57         | -          | 45,98      | 3387     | 0:39.72  | 62         | -          | 39,25      | 3482      |
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| python3.7   |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| none/single | 6:04.62  | 192.92     | 17.97      | 6.80       | 56+2364  | 6:15.96  | 284.56     | 24.73      | 5.82       | 75+4556  | 5:55.19  | 295.86     | 24.37      | 4.45       | 85+6375  | 6:52.05  | 329.77     | 24.22      | 4.97       | 94+8900  | 6:13.02  | 313.67     | 25.99      | 4.36       | 100+11100 |
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| python3.8   |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| none/single | 7:18.26  | 182.17     | 16.14      | 5,66       | 56+2364  | 6:57.87  | 248.38     | 23.69      | 5,22       | 75+4566  | 6:15.87  | 249.30     | 24.92      | 4,17       | 85+6379  | 7:59.62  | 290.52     | 23.05      | 4,21       | 94+8985  | 7:00.84  | 281.65     | 24.62      | 3,81       | 100+11193 |
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| python3.9   |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| none/single | 7:58.34  | 181.36     | 15.36      | 5,14       | 56+2364  | 6:50.46  | 255.39     | 23.29      | 5,31       | 75+4541  | 6:26.75  | 278.30     | 23.18      | 4,08       | 85+6328  | 8:00.36  | 312.73     | 24.07      | 4,20       | 94+8939  | 7:00.26  | 292.26     | 22.59      | 3,82       | 100+11135 |
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| python3.10  |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| none/single | 7:10.13  | 178.99     | 16.96      | 5,71       | 56+2364  | 7:23.13  | 231.48     | 23.50      | 4,92       | 75+4540  | 7:18.46  | 244.89     | 25.26      | 3,59       | 85+6329  | 8:06.95  | 261.54     | 25.70      | 4,14       | 94+8877  | 7:22.91  | 261.54     | 26.97      | 3,61       | 100+11097 |
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| python3.11  |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| none/single |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| python3.12  |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| none/single |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| **Mode**    | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** |  **size** |
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| python3.7   |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| zstd/single | 6:13.06  | 179.34     | 16.25      | 6.60       | 56+887   | 7:47.26  | 258.31     | 20.61      | 4.68       | 75+1551  | 6:12.97  | 277.80     | 25.05      | 4.23       | 85+2086  | 6:52.69  | 330.03     | 24.99      | 4.90       | 94+2843  | 6:36.94  | 312.96     | 23.48      | 4.07       | 100+3463  |
| zstd/thread | 6:38.02  | 242.13     | 16.28      | 6,32       | 56+891   | 6:42.33  | 322.78     | 23.20      | 5,44       | 75+1558  | 6:15.32  | 336.16     | 23.35      | 4,22       | 85+2095  | 6:55.77  | 365.74     | 22.73      | 4,86       | 94+2835  | 6:44.41  | 375.98     | 23.34      | 4,00       | 100+3461  |
| zstd/process| 6:55.59  | 192.36     | 14.70      | 6,04       | 56+892   | 6:55.42  | 283.42     | 20.51      | 5,28       | 75+1556  | 5:51.02  | 289        | 23.10      | 4,43       | 85+2092  | 8:05.54  | 256.05     | 19.71      | 4,16       | 94+2834  | 7:04.70  | 301.29     | 22.83      | 3,78       | 100+3461  |
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| python3.8   |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| zstd/single | 7:25.87  | 168.82     | 14.99      | 5,50       | 58+887   | 7:27.74  | 223.93     | 22.79      | 4,86       | 75+1550  | 8:05.37  | 249.22     | 22.78      | 3,24       | 85+2083  | 8:44.01  | 288.03     | 20.12      | 3,87       | 94+2825  | 8:11.99  | 290.43     | 22.95      | 3,27       | 100+3457  |
| zstd/thread | 7:59.65  | 203.57     | 13.97      | 5,10       | 56+891   | 7:28.99  | 304.94     | 22.19      | 4,84       | 75+1559  | 7:03.62  | 298.18     | 21.46      | 3,73       | 85+2094  | 8:04.02  | 318.29     | 20.95      | 4,16       | 94+2838  | 7:15.88  | 319.43     | 20.86      | 3,69       | 100+3463  |
| zstd/process| 7:36.71  | 164.90     | 14.19      | 5,37       | 56+891   | 7:49.24  | 261.61     | 19.69      | 4,65       | 75+1561  | 8:08.46  | 257.31     | 21.48      | 3,23       | 85+2097  | 9:42.12  | 239.21     | 18.27      | 3,46       | 94+2843  | 8:26.12  | 257.86     | 21.28      | 3,17       | 100+3470  |
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| python3.9   |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| zstd/single | 7:22.47  | 163.37     | 14.73      | 5,53       | 56+887   | 7:15.81  | 252.80     | 21.92      | 5,03       | 75+1552  | 6:46.81  | 254.81     | 24.76      | 3,90       | 85+2085  | 8:07.35  | 315.07     | 22.90      | 4,18       | 94+2831  | 7:30.41  | 294.20     | 23.19      | 3,58       | 100+3456  |
| zstd/thread | 8:07.34  | 211.99     | 14.21      | 5,05       | 56+891   | 7:34.69  | 282.80     | 20.43      | 4,80       | 75+1556  | 8:19.33  | 275.51     | 20.09      | 3,15       | 85+2088  | 8:26.17  | 310.70     | 22.11      | 3,99       | 94+2829  | 7:15.40  | 330.33     | 22.36      | 3,69       | 100+3454  |
| zstd/process| 7:38.21  | 161.47     | 14.29      | 5,35       | 56+891   | 7:54.83  | 234.32     | 20.93      | 4,59       | 75+1561  | 7:22.48  | 253.85     | 21.58      | 3,55       | 85+2093  | 8:32.17  | 255.68     | 21.89      | 3,93       | 94+2854  | 8:41.01  | 256.45     | 19.06      | 3,08       | 100+3490  |
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| python3.10  |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| zstd/single | 7:37.83  | 162.26     | 15.90      | 5,35       | 56+887   | 8:09.47  | 239.22     | 22.52      | 4,52       | 75+1549  | 6:47.80  | 262.19     | 24.27      | 3,92       | 85+2081  | 7:45.95  | 316.68     | 23.68      | 4,36       | 94+2820  | 7:01.73  | 301.82     | 25.27      | 3,84       | 100+3443  |
| zstd/thread | 7:23.90  | 219.75     | 15.29      | 5,52       | 56+892   | 7:36.88  | 305.13     | 21.25      | 4,78       | 75+1557  | 7:38.67  | 296.80     | 22.29      | 3,44       | 85+2087  | 7:34.77  | 397.43     | 23.87      | 4,45       | 94+2828  | 7:08.72  | 365.45     | 25.05      | 3,75       | 100+3463  |
| zstd/process| 7:19.83  | 173.06     | 15.60      | 5,57       | 56+891   | 7:44.81  | 249.08     | 20.02      | 4,70       | 75+1560  | 7:02.69  | 246.14     | 23.38      | 3,73       | 85+2097  | 7:44.82  | 276.26     | 22.73      | 4,35       | 94+2841  | 7:32.80  | 274.59     | 23.85      | 3,55       | 100+3473  |
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| python3.11  |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| zstd/single |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| zstd/thread |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| zstd/process|          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| python3.12  |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| zstd/single |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| zstd/thread |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| zstd/process|          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|

* :time   - время работы dedupsqlfs, в том числе и umount, по замеру утилиты time
* :memory - размер в памяти, согласно отладке в mount (--memory-usage) MiB
* :speedD - показатели отладки dedupsqlfs по скорости записи данных (write stream speed), MiB/s
* :speedR - показатели rsync по скорости записи данных, MiB/s
* :size   - размер итоговых данных в ~/Temp/sqlfs/data/, MiB + размер итоговых данных в ~/Temp/sqlfs/cldata/, MiB

## Результат

Просто посмотреть и сравнить обновление версий python. И сколько памяти тратится. И как работают потоки, процессы.

- rsync-3.2 более привильно испольует ФС при синхронизации
- и много-поточность + сжатие - немного больше памяти использует, и немного замедляет работу ФС.
- и много-процессность + сжатие - немного меньше памяти использует, в среднем немного ускоряет работу ФС. Видимо нужно проверить более затратные методы сжатия.
- плюс python3.11 работает быстрее, чем старые версии
- сжатие чуть замедляет работу ФС.