# Простые тесты скорости работы DedupSQLfs v1.2.953 за 22.06.2023

Проверка работы много-поточно-процессности на больших данных.
Плюс - исправленная+обновленная версия модуля zstd, и обновленные - llfuse, recordclass.
Плюс - кластерные таблицы блоков, хешей.
Плюс - новые версии Qt, python.
Плюс - проверка работы "партиционирования" таблицы-файла блоков.

Cинхронизация Qt с помощью rsync.

Проверка работы на движке: sqlite 3.40.1

- CPU: i5-6600K @ 3.50GHz
- DISK: 500Gb SSD NVMe
- Файлы Qt лежат на squashfs+zstd

System: Ubuntu 18.04 amd64

Disk FS: ext4, no barrier

Kernel: 5.4.0-150-lowlatency

Python:
- 3.7.17
- 3.8.17
- 3.9.17
- 3.10.12
- 3.11.4
- 3.12.0~b3

Модули:
- zstd: 1.5.5-r0
- llfuse: 1.4.4
- recordclass: 0.18.4

Размер Qt в tar:

* 5.12.12 - 2296M (596M squashed)
* 5.15.10 - 3102M (742M squashed)
* 6.2.4 - 3034M (753 squashed)
* 6.4.3 - 3387M (866 squahsed)
* 6.5.1 - 3482M (867 squashed)

Другое: включен autocommit, выключен sync, hash=md5, blocksize=128k, 

Команда:
```sh
/usr/bin/time -v python3.11 ./mount.dedupsqlfs -vv --verbose-stats --memory-usage \
 --data $HOME/Temp/sqlfs/data/ \
 --data-clustered $HOME/Temp/sqlfs/cldata/ \
 --block-partitions 10 \
 --compress zstd:3 \
 --no-sync --no-cache-flusher --minimal-compress-size -1 \
 --multi-cpu {mode} \
 -o noatime $HOME/Temp/sqlfs/mount
```

Синхронизация Qt:
```sh
rsync-3.2 -aHh --stats --delete --sparse --inplace --no-whole-file {qt-dir}/ $HOME/Temp/sqlfs/mount/Qt/ && sudo umount $HOME/Temp/sqlfs/mount
```

Синхронизация происходила поверх предыдущих копий Qt.
Тестировалась в том числе и дедупликация.
После синхронизации не делалась дефрагментация и vacuum.

Тестировались только методы (--compress):

* none
* zstd:3

Тестировались режимы работы (--multi-cpu):

* single
* thread
* process

## Тесты

| Qt ver      | 5.12.12                                                ||||| 5.15.10                                                ||||| 6.2.4                                                  ||||| 6.4.3                                                  ||||| 6.5.1                                                   |||||
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| **Mode**    | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** |  **size** |
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| rsync only  | 0:19.96  | 57         | -          | 118.60     | 2296     | 0:34.79  | 48         | -          | 54,25      | 3102     | 0:37.87  | 63         | -          | 40,30      | 3034     | 0:42.90  | 57         | -          | 45,98      | 3387     | 0:39.72  | 62         | -          | 39,25      | 3482      |
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| python3.7   |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| none/single | 6:04.62  | 192.92     | 17.97      | 6.80       | 56+2364  | 6:15.96  | 284.56     | 24.73      | 5.82       | 75+4556  | 5:55.19  | 295.86     | 24.37      | 4.45       | 85+6375  | 6:52.05  | 329.77     | 24.22      | 4.97       | 94+8900  | 6:13.02  | 313.67     | 25.99      | 4.36       | 100+11100 |
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| python3.8   |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| none/single |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| python3.9   |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| none/single |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| python3.10  |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| none/single |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| python3.11  |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| none/single |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| python3.12  |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| none/single |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| **Mode**    | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** |  **size** |
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| python3.7   |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| zstd/single | 6:13.06  | 179.34     | 16.25      | 6.60       | 56+887   | 7:47.26  | 258.31     | 20.61      | 4.68       | 75+1551  | 6:12.97  | 277.80     | 25.05      | 4.23       | 85+2086  | 6:52.69  | 330.03     | 24.99      | 4.90       | 94+2843  | 6:36.94  | 312.96     | 23.48      | 4.07       | 100+3463  |
| zstd/thread | 6:38.02  | 242.13     | 16.28      | 6,32       | 56+891   | 6:42.33  | 322.78     | 23.20      | 5,44       | 75+1558  | 6:15.32  | 336.16     | 23.35      | 4,22       | 85+2095  | 6:55.77  | 365.74     | 22.73      | 4,86       | 94+2835  | 6:44.41  | 375.98     | 23.34      | 4,00       | 100+3461  |
| zstd/process| 6:55.59  | 192.36     | 14.70      | 6,04       | 56+892   | 6:55.42  | 283.42     | 20.51      | 5,28       | 75+1556  | 5:51.02  | 289        | 23.10      | 4,43       | 85+2092  | 8:05.54  | 256.05     | 19.71      | 4,16       | 94+2834  | 7:04.70  | 301.29     | 22.83      | 3,78       | 100+3461  |
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| python3.8   |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| zstd/single |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| zstd/thread |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| zstd/process|          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| python3.9   |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| zstd/single |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| zstd/thread |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| zstd/process|          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| python3.10  |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| zstd/single |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| zstd/thread |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| zstd/process|          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| python3.11  |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| zstd/single |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| zstd/thread |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| zstd/process|          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| python3.12  |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| zstd/single |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| zstd/thread |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
| zstd/process|          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |          |          |            |            |            |           |
|-------------|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|

* :time   - время работы dedupsqlfs, в том числе и umount, по замеру утилиты time
* :memory - размер в памяти, согласно отладке в mount (--memory-usage) MiB
* :speedD - показатели отладки dedupsqlfs по скорости записи данных (write stream speed), MiB/s
* :speedR - показатели rsync по скорости записи данных, MiB/s
* :size   - размер итоговых данных в ~/Temp/sqlfs/data/, MiB + размер итоговых данных в ~/Temp/sqlfs/cldata/, MiB

## Результат

Просто посмотреть и сравнить обновление версии модуля. И сколько памяти тратится.

- rsync более агрессивно испольует ФС при синхронизации
- и много-поточность + сжатие - немного ускоряет работу ФС
- и много-процессность + сжатие - немного ускоряет работу ФС, видимо нужно использовать при более затратных методах сжатия
- плюс python3.11 работает быстрее, чем старые версии
- сжатие позитивно сказывается на времени синхронизации, меньше данных писать на диск
