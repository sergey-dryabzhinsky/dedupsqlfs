# Простые тесты скорости работы DedupSQLfs v1.2.953 за 26.06.2023

Проверка работы "кластеризации" хранения таблицы блоков, хешей, на больших данных.
Без дефрагментации. С "партиционированием" блоков.
Плюс заполнение новой таблицы для дефрагментации.

Cинхронизация Qt с помощью rsync.

Проверка работы на движке: sqlite 3.40.1

- CPU: i5-6600K @ 3.50GHz
- DISK: 500Gb SSD NVMe
- Файлы Qt лежат на squashfs+zstd

System: Ubuntu 18.04 amd64

Disk FS: ext4, no barrier

Kernel: 5.4.0-150-lowlatency

Python:
- 3.11.4

Модули:
- xz: 1.5.5-r1
- llfuse: 1.4.4
- recordclass: 0.18.4

Размер Qt в tar:

* 5.12.12 - 2296M (596M squashed)
* 6.5.1 - 3482M (867 squashed)

Другое: включен autocommit, выключен sync, hash=md5, blocksize=128k

Команда:
```sh
/usr/bin/time -v python3.11 ./mount.dedupsqlfs -vv --verbose-stats --memory-usage \
 --data $HOME/Temp/sqlfs/data/ \
 [--data-clustered $HOME/Temp/sqlfs/cldata/] \
 --block-partitions 10 \
 --compress zstd:3 \
 --no-sync --no-cache-flusher --minimal-compress-size -1 \
 --multi-cpu {mode} \
 -o noatime $HOME/Temp/sqlfs/mount
```

Синхронизация Qt:
```sh
/usr/bin/time -v rsync-3.2 -aHh --stats --delete --sparse --inplace --no-whole-file {qt-dir}/ $HOME/Temp/sqlfs/mount/Qt/ && sudo umount $HOME/Temp/sqlfs/mount
```

Синхронизация происходила поверх предыдущих копий Qt.
Тестировалась в том числе и дедупликация.
После синхронизации не делалась дефрагментация и vacuum.

Тестировались только методы (--compress):

* none
* xz:0

Тестировались режимы работы (--multi-cpu):

* single
* thread
* process

## Тесты

| Qt ver      | 5.12.12                                                           ||||| 6.5.1                                                              |||||
|-------------|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| **Mode**    | **time** | **CPU%** | **memory** | **speedD** | **speedR** | **size** | **time** | **CPU%** | **memory** | **speedD** | **speedR** |  **size** |
|-------------|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| rsync only  | 0:29.64  | 80       | 23         | -          | 79,73      | 2296     | 0:49.69  | 82       | 65         | -          | 62,26      | 3482      |
|-------------|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| no partition|          |          |            |            |            |          |          |          |            |            |            |           |
| none/single | 5:52.32  | 88       | 193.41     | 20.36      | 7,00       | 2421     | 7:22.42  | 88       | 271.11     | 24.84      | 7,17       | 5704      |
|-------------|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| partition   |          |          |            |            |            |          |          |          |            |            |            |           |
| none/single | 5:45.82  | 89       | 200.69     | 20.70      | 7,10       | 56+2366  | 7:24.16  | 88       | 276.35     | 26.62      | 7,15       | 84+5631   |
|-------------|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| **Mode**    | **time** | **CPU%** | **memory** | **speedD** | **speedR** | **size** | **time** | **CPU%** | **memory** | **speedD** | **speedR** |  **size** |
|-------------|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| no partition|          |          |            |            |            |          |          |          |            |            |            |           |
| xz/single   | 8:05.99  | 90       | 174.83     | 9.50       | 5,04       | 935      | 11:52.88 | 86       | 222.81     | 11.30      | 4,45       | 1942      |
| xz/thread   | 6:50.14  | 114      | 208.78     | 14.91      | 5,98       | 939      | 9:15.38  | 111      | 246.91     | 20.20      | 5,70       | 1950      |
| xz/process  | 6:55.12  | 120      | 176.74     | 14.35      | 5,89       | 939      | 9:25.79  | 117      | 224.44     | 18.67      | 5,62       | 1949      |
|-------------|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| partition   |          |          |            |            |            |          |          |          |            |            |            |           |
| xz/single   | 8:33.83  | 88       | 175.51     | 9.36       | 4,76       | 56+879   | 10:57.23 | 90       | 227.52     | 13.97      | 4,82       | 84+1860   |
| xz/thread   | 7:13.27  | 103      | 189.85     | 12.95      | 5,66       | 56+883   | 10:16.18 | 98       | 236.33     | 17.20      | 5,14       | 84+1866   |
| xz/process  | 7:27.17  | 111      | 171.66     | 12.93      | 5,48       | 56+883   | 10:15.09 | 106      | 227.29     | 17.68      | 5,15       | 84+1867   |
|-------------|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|

* :time   - время работы dedupsqlfs, в том числе и umount, по замеру утилиты time
* :CPU    - загрузка процессора в % в dedupsqlfs, согласно отчету утилиты time
* :memory - размер в памяти dedupsqlfs, согласно отладке в mount (--memory-usage), или согласно отчету утилиты time, MiB,
* :speedD - показатели отладки dedupsqlfs по скорости записи данных (write stream speed), MiB/s
* :speedR - показатели rsync по скорости записи данных, MiB/s
* :size   - размер итоговых данных в ~/Temp/sqlfs/data/, MiB + размер итоговых данных в ~/Temp/sqlfs/cldata/, MiB

## Результат

Просто посмотреть и сравнить обновление версий python. И сколько памяти тратится. И как работают потоки, процессы.

- rsync-3.2 более привильно испольует ФС при синхронизации
- и много-поточность + сжатие - немного больше памяти использует, и немного замедляет работу ФС. Начиная с python3.10 - ускоряет работу ФС.
- и много-процессность + сжатие - немного меньше памяти использует, в среднем немного ускоряет работу ФС. Видимо нужно проверить более затратные методы сжатия.
- сжатие чуть замедляет работу ФС.
