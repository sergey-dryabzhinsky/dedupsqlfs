# Простые тесты скорости работы DedupSQLfs v1.2.953 за 26.06.2023

Проверка работы "партиционирования" таблицы блоков на больших данных.
Без дефрагментации.

Cинхронизация Qt с помощью rsync.

Проверка работы на движке: sqlite 3.40.1

- CPU: i5-6600K @ 3.50GHz
- DISK: 500Gb SSD NVMe
- Файлы Qt лежат на squashfs+zstd

System: Ubuntu 18.04 amd64

Disk FS: ext4, no barrier

Kernel: 5.4.0-150-lowlatency

Python:
- 3.11.4

Модули:
- xz: 1.5.5-r1
- llfuse: 1.4.4
- recordclass: 0.18.4

Размер Qt в tar:

* 5.12.12 - 2296M (596M squashed)
* 6.5.1 - 3482M (867 squashed)

Другое: включен autocommit, выключен sync, hash=md5, blocksize=128k

Команда:
```sh
/usr/bin/time -v python3.11 ./mount.dedupsqlfs -vv --verbose-stats --memory-usage \
 --data $HOME/Temp/sqlfs/data/ \
 --data-clustered $HOME/Temp/sqlfs/cldata/ \
 --block-partitions 10 \
 --compress zstd:3 \
 --no-sync --no-cache-flusher --minimal-compress-size -1 \
 --multi-cpu {mode} \
 -o noatime $HOME/Temp/sqlfs/mount
```

Синхронизация Qt:
```sh
/usr/bin/time -v rsync-3.2 -aHh --stats --delete --sparse --inplace --no-whole-file {qt-dir}/ $HOME/Temp/sqlfs/mount/Qt/ && sudo umount $HOME/Temp/sqlfs/mount
```

Синхронизация происходила поверх предыдущих копий Qt.
Тестировалась в том числе и дедупликация.
После синхронизации не делалась дефрагментация и vacuum.

Тестировались только методы (--compress):

* none
* xz:0

Тестировались режимы работы (--multi-cpu):

* single
* thread
* process

## Тесты

| Qt ver      | 5.12.12                                                             ||||| 6.5.1                                                            |||||
|-------------|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| **Mode**    | **time** | **CPU%** | **memory** | **speedD** | **speedR** | **size** | **time** | **CPU%** | **memory** | **speedD** | **speedR** |  **size** |
|-------------|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| rsync only  |          |          |            | -          |            |          |          |          |            | -          |            |           |
|-------------|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| no partition|          |          |            |            |            |          |          |          |            |            |            |           |
| none/single |          |          |            |            |            |          |          |          |            |            |            |           |
|-------------|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| partition   |          |          |            |            |            |          |          |          |            |            |            |           |
| none/single |          |          |            |            |            |          |          |          |            |            |            |           |
|-------------|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| **Mode**    | **time** | **CPU%** | **memory** | **speedD** | **speedR** | **size** | **time** | **CPU%** | **memory** | **speedD** | **speedR** |  **size** |
|-------------|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| no partition|          |          |            |            |            |          |          |          |            |            |            |           |
| xz/single   |          |          |            |            |            |          |          |          |            |            |            |           |
| xz/thread   |          |          |            |            |            |          |          |          |            |            |            |           |
| xz/process  |          |          |            |            |            |          |          |          |            |            |            |           |
|-------------|:--------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| partition   |          |          |            |            |            |          |          |          |            |            |            |           |
| xz/single   |          |          |            |            |            |          |          |          |            |            |            |           |
| xz/thread   |          |          |            |            |            |          |          |          |            |            |            |           |
| xz/process  |          |          |            |            |            |          |          |          |            |            |            |           |
|-------------|:--------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|

* :time   - время работы dedupsqlfs, в том числе и umount, по замеру утилиты time
* :CPU    - загрузка процессора в % в dedupsqlfs, согласно отчету утилиты time
* :memory - размер в памяти dedupsqlfs, согласно отладке в mount (--memory-usage) MiB
* :speedD - показатели отладки dedupsqlfs по скорости записи данных (write stream speed), MiB/s
* :speedR - показатели rsync по скорости записи данных, MiB/s
* :size   - размер итоговых данных в ~/Temp/sqlfs/data/, MiB + размер итоговых данных в ~/Temp/sqlfs/cldata/, MiB

## Результат

Просто посмотреть и сравнить обновление версий python. И сколько памяти тратится. И как работают потоки, процессы.

- rsync-3.2 более привильно испольует ФС при синхронизации
- и много-поточность + сжатие - немного больше памяти использует, и немного замедляет работу ФС. Начиная с python3.10 - ускоряет работу ФС.
- и много-процессность + сжатие - немного меньше памяти использует, в среднем немного ускоряет работу ФС. Видимо нужно проверить более затратные методы сжатия.
- сжатие чуть замедляет работу ФС.
