# Простые тесты скорости работы DedupSQLfs v1.2.953 за 26.06.2023

Проверка работы "партиционирования" хранения таблицы блоков, на больших данных.
Без дефрагментации.
Плюс заполнение новой таблицы для дефрагментации.

Cинхронизация Qt с помощью rsync.

Проверка работы на движке: sqlite 3.40.1

- CPU: i5-6600K @ 3.50GHz
- DISK: 500Gb SSD NVMe
- Файлы Qt лежат на squashfs+zstd

System: Ubuntu 18.04 amd64

Disk FS: ext4, no barrier

Kernel: 5.4.0-150-lowlatency

Python:
- 3.11.4

Модули:
- xz: 0.0.3
- llfuse: 1.4.4
- recordclass: 0.18.4

Размер Qt в tar:

* 5.12.12 - 2296M (596M squashed)
* 6.5.1 - 3482M (867 squashed)

Другое: включен autocommit, выключен sync, hash=md5, blocksize=128k

Команда:
```sh
/usr/bin/time -v python3.11 ./mount.dedupsqlfs -vv --verbose-stats --memory-usage \
 --data $HOME/Temp/sqlfs/data/ \
 [--block-partitions 1/10/100] \
 --compress [none/xz:0] \
 --no-sync --no-cache-flusher --minimal-compress-size -1 \
 --multi-cpu {mode} \
 -o noatime $HOME/Temp/sqlfs/mount
```

Синхронизация Qt:
```sh
/usr/bin/time -v rsync-3.2 -aHh --stats --delete --sparse --inplace --no-whole-file {qt-dir}/ $HOME/Temp/sqlfs/mount/Qt/ && sudo umount $HOME/Temp/sqlfs/mount
```

Синхронизация происходила поверх предыдущих копий Qt.
Тестировалась в том числе и дедупликация.
После синхронизации не делалась дефрагментация и vacuum.

Тестировались только методы (--compress):

* none
* xz:0

Тестировались режимы работы (--multi-cpu):

* single
* thread
* process

## Тесты

| Qt ver      | 5.12.12                                                          |||||| 6.5.1                                                             ||||||
|-------------|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| **Mode**    | **time** | **CPU%** | **memory** | **speedD** | **speedR** | **size** | **time** | **CPU%** | **memory** | **speedD** | **speedR** |  **size** |
|-------------|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| rsync only  | 0:29.64  | 80       | 23         | -          | 79,73      | 2296     | 0:49.69  | 82       | 65         | -          | 62,26      | 3482      |
|-------------|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| no partition|          |          |            |            |            |          |          |          |            |            |            |           |
| none/single | 6:17.43  | 84       | 153.86     | 18.95      | 6,51       | 2421     | 7:48.44  | 85       | 215.48     | 24.83      | 6,77       | 5708      |
|-------------|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| parts/10    |          |          |            |            |            |          |          |          |            |            |            |           |
| none/single | 5:58.36  | 87       | 191.07     | 18.86      | 6,86       | 2421     | 7:31.83  | 87       | 266.80     | 26.03      | 7,02       | 5708      |
|-------------|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| parts/100   |          |          |            |            |            |          |          |          |            |            |            |           |
| none/single | 5:59.65  | 87       | 239.71     | 18.97      | 6,86       | 2421     | 8:18.04  | 82       | 341.67     | 23.49      | 6,37       | 5708      |
|-------------|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| **Mode**    | **time** | **CPU%** | **memory** | **speedD** | **speedR** | **size** | **time** | **CPU%** | **memory** | **speedD** | **speedR** |  **size** |
|-------------|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| no partition|          |          |            |            |            |          |          |          |            |            |            |           |
| xz/single   | 8:28.61  | 89       | 148.38     | 9.31       | 4,82       | 935      | 12:01.38 | 87       | 182.51     | 11.45      | 4,39       | 1942      |
| xz/thread   | 7:05.84  | 112      | 158.96     | 14.29      | 5,76       | 941      | 9:12.64  | 112      | 211.44     | 18.85      | 5,72       | 1953      |
| xz/process  | 6:52.50  | 124      | 153.03     | 15.43      | 5,94       | 941      | 9:07.90  | 119      | 198.20     | 20.27      | 5,77       | 1953      |
|-------------|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| parts/10    |          |          |            |            |            |          |          |          |            |            |            |           |
| xz/single   | 6:50.04  | 122      | 176.87     | 8.88       | 4,89       | 935      | 11:26.99 | 88       | 230.28     | 12.02      | 4,61       | 1942      |
| xz/thread   | 7:09.13  | 106      | 194.92     | 14.13      | 5,71       | 939      | 10:28.38 | 99       | 470.52     | 17.35      | 5,03       | 1950      |
| xz/process  | 7:16.53  | 111      | 189.40     | 13.50      | 5,64       | 939      | 10:16.58 | 105      | 235.77     | 17.38      | 5,14       | 1949      |
|-------------|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|
| parts/100   |          |          |            |            |            |          |          |          |            |            |            |           |
| xz/single   | 8:32.06  | 86       | 201.11     | 9.37       | 4,78       | 936      | 13:04.14 | 75       | 231.86     | 12.23      | 4,04       | 1942      |
| xz/thread   | 7:41.42  | 97       | 238.35     | 13.25      | 5,30       | 937      | 10:55.18 | 94       | 252.73     | 17.08      | 4,83       | 1943      |
| xz/process  | 8:12.07  | 100      | 233.97     | 12.53      | 4,98       | 937      | 10:37.02 | 107      | 254.70     | 18.34      | 5,00       | 1943      |
|-------------|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:--------:|:----------:|:----------:|:----------:|:---------:|

* :time   - время работы dedupsqlfs, в том числе и umount, по замеру утилиты time
* :CPU    - загрузка процессора в % в dedupsqlfs, согласно отчету утилиты time
* :memory - размер в памяти dedupsqlfs, согласно отладке в mount (--memory-usage), или согласно отчету утилиты time, MiB,
* :speedD - показатели отладки dedupsqlfs по скорости записи данных (write stream speed), MiB/s
* :speedR - показатели rsync по скорости записи данных, MiB/s
* :size   - размер итоговых данных в ~/Temp/sqlfs/data/, MiB + размер итоговых данных в ~/Temp/sqlfs/cldata/, MiB

## Результат

Просто посмотреть и сравнить обновление версий python. И сколько памяти тратится. И как работают потоки, процессы.

- использование разделения таблицы блоков ускоряет работу ФС
- использование разделения таблицы блоков увеличивает использование памяти
- нужно использовать разбиение так, чтобы получались файлы-таблицы до 4-8Гб, но и не слишком мелкие
- и много-поточность + сжатие - немного больше памяти использует, и немного ускоряет работу ФС.
- и много-процессность + сжатие - немного меньше памяти использует, в среднем немного ускоряет работу ФС.
